<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>È†ëÂºµ„Çå‚ÄºÔ∏èüò§„Å°„ÇÉ„Çì</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
            @import url('https://fonts.googleapis.com/css2?family=DotGothic16&display=swap');
            body { font-family: 'DotGothic16', sans-serif; background-color: #1a1a1a; overflow: hidden; touch-action: none; height: 100dvh; width: 100vw; margin: 0; }
            .text-shadow { text-shadow: 2px 2px 0px #000; }
            .message-box { background: rgba(0, 0, 0, 0.7); border: 4px solid #f472b6; border-radius: 15px; color: white; }
            @keyframes zoomIn { 0% { transform: scale(0.1) translate(-50%, 0); opacity: 0; } 20% { opacity: 1; } 100% { transform: scale(3.5) translate(-50%, 0); opacity: 1; } }
            .enemy-approach { animation: zoomIn var(--speed) linear forwards; transform-origin: center bottom; }
            .punch-action { animation: punchAnim 0.1s ease-out; }
            @keyframes punchAnim { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.5); } }
            .shake { animation: shake 0.3s cubic-bezier(.36,.07,.19,.97); }
            @keyframes shake { 10%, 90% { transform: translate3d(-2px, 0, 0); } 20% { transform: translate3d(4px, 0, 0); } }
            #target-guide { border: 6px dashed rgba(244, 114, 182, 0.4); width: 160px; height:160px;  position: absolute; border: 4px dashed rgba(244, 114, 182, 0.5); border-radius: 50%; width: 140px; height: 140px; top: 40%; left: 50%; transform: translate(-50%, -50%); pointer-events: none; z-index: 40; }
            #target-guide.active { border-color: #ff0000; border-style: solid; box-shadow: 0 0 30px #ff0000; background: rgba(255, 0, 0, 0.1); }
        </style>
    </head>
    <body class="flex flex-col">
        <div id="game-container" class="relative w-full h-full max-w-[500px] mx-auto bg-gray-900 overflow-hidden">
            <div id="bg-layer" class="absolute inset-0 bg-cover bg-center opacity-40 transition-all duration-1000"></div>

            <div id="action-scene" class="absolute inset-0 z-10 hidden">
                <div class="absolute top-10 right-4 w-40 h-8 bg-gray-700 border-2 border-white z-50 rounded-full overflow-hidden">
                    <div id="hp-bar" class="h-full bg-gradient-to-r from-pink-500 to-red-600 transition-all duration-200 w-full"></div>
                </div>
                <div id="hp-text" class="absolute top-11 right-20 z-50 text-white font-bold text-shadow text-sm pointer-events-none">HP</div>

                <div class="absolute top-20 right-4 z-50 text-white text-xl font-bold text-shadow text-right">
                    SCORE: <span id="score-val" class="text-yellow-400">0</span>
                </div>

                <div id="target-guide"></div>
                <div id="enemy-container" class="absolute inset-0 top-0 pointer-events-none overflow-visible"></div>
                <div class="absolute top-10 left-4 z-50 text-2xl text-white font-bold text-shadow">ÊÆã„Çä: <span id="enemy-count" class="text-pink-400">0</span></div>

                <div id="punch-zone" class="absolute bottom-0 w-full h-[50vh] z-30 flex flex-col items-center justify-end pb-12 cursor-pointer active:bg-white/5 transition-colors" onmousedown="tryPunch(event)" ontouchstart="tryPunch(event)">
                    <div id="player-fist" class="text-8xl transition-transform filter drop-shadow-lg">üëä</div>
                </div>
            </div>

            <div id="novel-scene" class="absolute inset-0 z-20 hidden flex flex-col justify-end p-4 pb-12">
                <div id="novel-chars" class="flex justify-center items-end mb-4 h-64"></div>
                <div id="name-tag" class="w-fit self-start px-4 py-1 bg-pink-600 text-white rounded-t-lg font-bold"></div>
                <div class="message-box p-4 h-32 text-lg cursor-pointer overflow-y-auto" onclick="nextNovelStep()">
                    <span id="message-text"></span>
                    <div class="text-right text-pink-400 animate-bounce">‚ñº</div>
                </div>
            </div>

            <div id="result-screen" class="absolute inset-0 bg-white/95 flex flex-col items-center justify-center z-[110] hidden p-6 text-center">
                <h2 class="text-4xl font-bold text-pink-600 mb-2">‚ú® Áã©„ÇäÁµÇ‰∫Ü ‚ú®</h2>
                <div class="text-2xl mb-2 text-gray-800">ÊúÄÁµÇ„Çπ„Ç≥„Ç¢</div>
                <div id="final-score" class="text-7xl font-bold text-pink-600 mb-10 text-shadow">0</div>
                <button onclick="location.reload()" class="px-10 py-4 bg-pink-600 text-white rounded-full text-2xl font-bold">„ÇÇ„ÅÜ‰∏ÄÂ∫¶Áã©„Çã</button>
            </div>

            <div id="title-screen" class="absolute inset-0 bg-pink-600 flex flex-col items-center justify-center z-50 p-4">
                <h1 class="text-5xl font-bold text-white text-shadow text-center mb-4 leading-snug">È†ëÂºµ„Çå‚ÄºÔ∏è<br>üò§„Å°„ÇÉ„Çì</h1>
                <button onclick="gameStart()" class="px-12 py-5 bg-white text-pink-600 rounded-full text-3xl font-bold shadow-xl">Áã©„Çä„ÇíÂßã„ÇÅ„Çã</button>
            </div>

            <div id="game-over" class="absolute inset-0 bg-black/95 flex flex-col items-center justify-center z-[100] hidden p-6 text-center">
                <h2 class="text-6xl font-bold text-red-600 mb-6">ÁÑ°Âøµ...</h2>
                <button onclick="location.reload()" class="px-10 py-4 bg-red-600 text-white rounded-full text-2xl font-bold">„É™„Éô„É≥„Ç∏„Åô„Çã</button>
            </div>
        </div>

        <script>
            const CHARS = {
                sonemi: { name: "üò§", emoji: "üò§", color: "bg-pink-600" },
                boy: { name: "üë¶", emoji: "üë¶", color: "bg-blue-500" },
                akira: { name: "üî™", emoji: "üî™", color: "bg-gray-500" },
                clown: { name: "ü§°", emoji: "ü§°", color: "bg-red-500" },
                smiley: { name: "üòå", emoji: "üòå", color: "bg-yellow-500" },
                hole: { name: "ü™è", emoji: "ü™è", color: "bg-gray-800" },
                devil: { name: "üëø", emoji: "üëø", color: "bg-purple-600" },
                camera: { name: "üì∑Ô∏è", emoji: "üì∑", color: "bg-black" }
            };

            const SCENARIOS = [
                { type: 'novel', bg: 'images/back.jpg', steps: [
                    { char: null, text: "Ôºà‰ªäÊó•„ÇÇ‰ªäÊó•„Å®„Å¶„Ç§„É©„Ç§„É©„Åó„Å¶„ÅÑ„Çãüò§„Å°„ÇÉ„ÇìÔºâ" },
                    { char: 'sonemi', text: "„ÅØ„ÅÇ‚Ä¶„Çπ„Éà„É¨„Çπ„ÅÆÈôêÁïå„Å†„Çè‚Ä¶‰Ωï„ÅãÊÜÇ„ÅïÊô¥„Çâ„Åó„Å´„Å™„Çã„Åì„Å®‚Ä¶" },
                    { char: null, text: "ÔºàÈÅãÊÇ™„ÅèÈÄö„Çä„Åã„Åã„Çãüë¶Ôºâ" },
                    { char: 'boy', text: "„ÅÇ„Å£‚ÄºÔ∏èüò§„Å°„ÇÉ„Çì‚ÅâÔ∏è‚Ä¶‰Ωï„Åó„Å¶„Çã„ÅÆ‚ùìÔ∏èÔºàÊÄØÔºâ" },
                    { char: 'sonemi', text: "„ÅÇ„Çâ„ÄÅ„ÅÑ„ÅÑ„Å®„Åì„Çç„Å´Êù•„Åü„Çè„Å≠„ÄÇ„Å°„Çá„Å£„Å®È°îË≤∏„Åó„Å™„Åï„ÅÑ„Çà„Éº„Éº„Éºüëä" },
                    { char: 'boy', text: "„Å™„ÄÅ„Å™„Çì„ÅßÊã≥Êè°„Å£„Å¶„Çã„ÅÆ‚ÅâÔ∏èÊÄñ„ÅÑ„Çà„ÄÅË™∞„ÅãÂä©„Åë" },
                    { char: 'akira', text: "„Åè„Å£„Åè„Å£„Åè‚Ä¶„ÇÑ„Å£„Å®Ë¶ã„Å§„Åë„Åü„Åûüë¶‚ÄºÔ∏èÂÉï„ÅÆ„Äéüëø„ÇÑ„Å£„Å§„ÅëÂ§ß‰ΩúÊà¶„Äè„Å´ÂçîÂäõ„Åó„Ççüë¶‚ÄºÔ∏è" },
                    { char: 'sonemi', text: "„ÅØ„ÅÅ‚ùìÔ∏èË™∞„Çà„ÅÇ„Çì„Åü‚ÄºÔ∏èÁßÅ„ÅÆ„Ç™„É¢„ÉÅ„É£„Å´Êåá‰∏ÄÊú¨Ëß¶„Çå„Å¶„Åø„Å™„Åï„ÅÑ„ÄÇ„Åù„ÅÆÈºª„ÄÅ„Å∏„ÅóÊäò„Å£„Å¶„ÇÑ„Çã„Çè‚ÄºÔ∏è" },
                    { char: 'akira', text: "„ÅäÂâç„Åì„Åù„Å†„Çå„Å†„Çà‚ÅâÔ∏è„Åæ„ÅÇ„ÅÑ„ÅÑ„ÄÅÂèó„Åë„Å¶Á´ã„Å£„Å¶„ÇÑ„Çã‚ÄºÔ∏è‚ÄºÔ∏è‚ÄºÔ∏è" },
                    { char: 'boy', text: "‚Ä¶‰ø∫„ÅØüò§„Å°„ÇÉ„Çì„ÅÆ„Ç™„É¢„ÉÅ„É£„Åò„ÇÉ„Å™„ÅÑ„Çà‚ÅâÔ∏è" }
                ]},
                { type: 'action', enemyEmoji: "üî™", count: 20, speedBase: 1500 },
                { type: 'novel', bg: 'images/back.jpg', steps: [
                    { char: 'akira', text: "„Åê„ÅÇ„ÅÇ„Å£‚ÄºÔ∏è‚Ä¶„Å™„Åã„Å™„Åã„ÇÑ„Çã„Åò„ÇÉ„Å™„ÅÑ„Åã‚Ä¶‰ªäÊó•„ÅØ„Åì„ÅÆËæ∫„ÅßÂãòÂºÅ„Åó„Å¶„ÇÑ„Çã‚ÄºÔ∏è" },
                    { char: null, text: "Ôºàüî™„ÅØÈÄÉ„Åí„Å¶„ÅÑ„Å£„Åü‚Ä¶Ôºâ" },
                    { char: 'sonemi', text: "ÈõëÈ≠ö„Åå„ÄÇÂè£„Åª„Å©„Å´„ÇÇ„Å™„ÅÑ„Çè„Å≠„ÄÇ‚Ä¶„Åï„Å¶üë¶„ÄÅÁ∂ö„Åç„Çí‚Ä¶üëä" },
                    { char: 'clown', text: "„Ç¢„ÇΩ„Éú‚ÄºÔ∏è„Ç¢„ÇΩ„Éú‚ÄºÔ∏è" },
                    { char: null, text: "ÔºàÊÆ∫‰∫∫ü§°„ÅåÁèæ„Çå„Åü‚ÄºÔ∏è‚ÄºÔ∏è‚ÄºÔ∏èÔºâ" },
                    { char: 'boy', text: "„Åé„Çá„Åà„Å¥„Äú‚ÄºÔ∏è" },
                    { char: 'sonemi', text: "‰ªäÂ∫¶„ÅØ‰Ωï‚ÅâÔ∏è‚Ä¶„Ç¢„É≥„Çø„Åø„Åü„ÅÑ„Å™Â§âË≥™ËÄÖ„Éî„Ç®„É≠„ÅØ„ÄÅÂú∞ÁçÑ„ÅßÁéâ‰πó„Çä„Åß„ÇÇ„Åó„Å¶„Å™„Åï„ÅÑ‚ÄºÔ∏è" }
                ]},
                { type: 'action', enemyEmoji: "ü§°", count: 35, speedBase: 1200 },
                { type: 'novel', bg: 'images/back.jpg', steps: [
                    { char: null, text: "Ôºà„Éú„Ç≥„Éú„Ç≥„Å´„Å™„Å£„Åüü§°„ÅØËµ∞„Å£„Å¶ÈÄÉ„Åí„Å¶„ÅÑ„Å£„Åü‚Ä¶Ôºâ" },
                    { char: 'clown', text: "„Éí„Çß„ÉÉ‚Ä¶ÊÄñ„ÅÑ„Çà„Åâ‚Ä¶Ôºàüò§„Å°„ÇÉ„Çì„ÅåÔºâ" },
                    { char: 'sonemi', text: "„Åµ„Çì„ÄÅ„Åì„ÅÑ„Å§„ÇÇÈõëÈ≠ö„Å≠„ÄÇ‚Ä¶„Åï„Å¶üë¶„ÄÅÁ∂ö„Åç„Çí‚Ä¶üëä" },
                    { char: null, text: "Ôºà„Çµ„Ç§„Ç≥„Éë„Çπ„ÅåÁèæ„Çå„ÅüÔºâ" },
                    { char: 'smiley', text: "ÁæéÂë≥„Åó„Åù„ÅÜ„Å™„ÅäËÇâ„ÇíË¶ã„Å§„Åë„Åæ„Åó„Åü„ÄÇ„ÅÑ„Åü„Å†„Åç„Åæ„Åôüòå" },
                    { char: 'boy', text: "„Åà‚ùìÔ∏è„ÇÇ„Åó„Åã„Åó„Å™„Åè„Å¶„ÇÇ‚Ä¶‰ø∫„ÅÆ„Åì„Å®‚ÅâÔ∏è‚Ä¶„Åù„Çì„Å™„Å´ÁæéÂë≥„Åó„Åù„ÅÜ„Åã„Å™‚Ä¶‚ùìÔ∏è" },
                    { char: 'sonemi', text: "‰ΩïÈ¶¨Èπø„Å™„Åì„Å®Ë®Ä„Å£„Å¶„Çì„ÅÆ‚ÅâÔ∏è‚Ä¶„ÅØ„ÅÇ„ÄÅÁßÅ„Åå„ÇÑ„Çã„Çè„ÄÇ„Ç¢„É≥„Çø„ÅØ‰∏ã„Åå„Å£„Å¶„Å™„Åï„ÅÑ‚ÄºÔ∏è" }
                ]},
                { type: 'action', enemyEmoji: "üòå", count: 40, speedBase: 1000 },
                { type: 'novel', bg: 'images/back.jpg', steps: [
                    { char: 'smiley', text: "„Åè„Å£‚Ä¶" },
                    { char: null, text: "ÔºàÂëΩ„ÅÆÂç±Èô∫„ÇíÊÑü„Åò„Åü„Çµ„Ç§„Ç≥„Éë„Çπ„ÅØÈÄÉËµ∞„Åó„ÅüÔºâ" },
                    { char: 'sonemi', text: "ÂÅèÈ£üÊ≤ª„Åó„Å¶Âá∫Áõ¥„Åó„Å¶„Åç„Å™‚ÄºÔ∏è‚Ä¶„Åæ„Å£„Åü„Åè„ÄÅ„Å™„Çì„Åß„Åì„ÅÜÊ¨°„Åã„ÇâÊ¨°„Å∏„Å®‚Ä¶" },
                    { char: 'hole', text: "‚Ä¶‚Ä¶‚Ä¶‚Ä¶ÔºàÁÑ°Ë®Ä„Åßü™è„ÇíÊßã„Åà„ÇãÁî∑Ôºâ" },
                    { char: 'boy', text: "„Åé„Çá„Åà„Å¥ÔΩû‚ÄºÔ∏è‚ÄºÔ∏èÊÆ∫‰∫∫È¨º„Å†~‚ÄºÔ∏èÂä©„Åë„Å¶ÔΩû‚ÄºÔ∏è‚ÄºÔ∏è" },
                    { char: 'sonemi', text: "„ÅÇ„Çì„Åü„ÅÆ„Çπ„Éà„Éº„Ç´„Éº‰Ωï‰∫∫„ÅÑ„Çã„ÅÆ‚ÅâÔ∏è" }
                ]},
                { type: 'action', enemyEmoji: "ü™è", count: 60, speedBase: 800 },
                { type: 'novel', bg: 'images/back.jpg', steps: [
                    { char: null, text: "ÔºàÊÆ∫‰∫∫È¨º„ÅØÁ©¥„ÅÆ‰∏≠„Å∏Â∏∞„Å£„Å¶„ÅÑ„Å£„ÅüÔºâ" },
                    { char: 'sonemi', text: "„ÅØ„ÅÅ‚Ä¶„ÅØ„ÅÅ‚Ä¶„Åì„Çå„ÅßÂÖ®Âì°‚ùìÔ∏è„Åï„Åô„Åå„Å´Áñ≤„Çå„Åü„Çè‚Ä¶" },
                    { char: 'sonemi', text: "„Åµ„ÅÜ„ÄÅ„ÇÑ„Å£„Å®‰∫å‰∫∫„Åç„Çä„Å≠„ÄÇË¶öÊÇü„Åó„Å™„Åï„ÅÑüëä" },
                    { char: 'boy', text: "„Å≤„ÅÉ„Å£‚ÄºÔ∏èüò§„Å°„ÇÉ„Çì„ÅÆÊñπ„ÅåÊïµ„Çà„ÇäÊñ≠ÁÑ∂ÊÄñ„ÅÑ„Çà‚ÄºÔ∏è„Åé„Çá„Åà„Å¥„Äú‚ÄºÔ∏è" },
                    { char: 'devil', text: "„Åù„Åì„Åæ„Åß„Åß„Éº„Åô‚ÄºÔ∏è‚ÄºÔ∏èÊúÄÈ´ò„ÅÆÂ•≥Â≠êÂ∞èÂ≠¶Áîü„ÅÆ„Éë„ÉØ„Éè„É©ÂãïÁîª„ÅåÊíÆ„Çå„Åæ„Åó„Åü‚ÄºÔ∏èÈ¨º„É§„Éê„Åß„Åô‚ÄºÔ∏è" },
                    { char: 'camera', text: "„Åò„Éº„Åò„ÉºÔºà„Éä„Ç§„ÇπÁîªËßí„Å†Ôºâ" },
                    { char: 'sonemi', text: "„Åæ„ÅüÁõóÊíÆ‚ÅâÔ∏èËÇñÂÉèÊ®©„ÅÆ‰æµÂÆ≥„ÅßË®¥„Åà„Çã„Çè„Çà‚ÄºÔ∏è" },
                    { char: 'devil', text: "„Ç´„Ç´„Ç´„ÉÉ‚ÄºÔ∏è„É¢„Ç∂„Ç§„ÇØ„Åã„Åë„Åæ„Åô„ÅÆ„Åß„ÅîÂøÉÈÖç„Å™„Åè‚ÄºÔ∏è" },
                    { char: 'sonemi', text: "‚Ä¶ÈÇ™È≠î„Åô„Çã„Å™„ÇâÂÆπËµ¶„Åó„Å™„ÅÑ„Çè„Çàüëä" }
                ]},
                { type: 'action', enemyEmoji: "üëø", count: 100, speedBase: 600 },
                { type: 'novel', bg: 'images/back.jpg', steps: [
                    { char: 'sonemi', text: "‚Ä¶ÁµÇ„Çè„Å£„Åü‚Ä¶‚ùìÔ∏èÁßÅ„ÅÆÂãù„Å°‚Ä¶„Çà„Å≠‚ùìÔ∏è" },
                    { char: 'devil', text: "„Å™„Åã„Å™„Åã„ÇÑ„Çä„Åæ„Åô„Å≠„Åà‚Ä¶‚ÄºÔ∏èüì∑Ô∏è„Å°„ÇÉ„ÇìÊíÆ„ÇåÈ´ò„Å©„ÅÜ„Åß„Åô‚ùìÔ∏è" },
                    { char: 'camera', text: "„Åò„Éº‚ÄºÔ∏èüëçÔ∏èÔºàÊúÄÈ´ò„Å†‚ÄºÔ∏èÔºâ" },
                    { char: 'devil', text: "„Åì„Çå„Å´„Å¶ÊíÆÂΩ±ÁµÇ‰∫Ü„Åß„Åô‚ÄºÔ∏èÊâì„Å°‰∏ä„Åí„Å´ÁÑº„ÅçËÇâ„Åß„ÇÇË°å„Åç„Åæ„Åó„Çá„ÅÜ„Åã‚ùìÔ∏èüë¶„Åè„Çì" },
                    { char: 'boy', text: "ÁÑºËÇâ‚ÅâÔ∏èË°å„ÅèË°å„Åè„Éº‚ÄºÔ∏è" },
                    { char: 'camera', text: "„Åò„Åò„Åò‚ÄºÔ∏èÔºà„Çø„É≥Â°©‚ÄºÔ∏èÁâπ‰∏ä„Ç´„É´„Éì„ÇÇ„Å™‚ÄºÔ∏èÔºâ" },
                    { char: 'sonemi', text: "„Å°„Çá„ÄÅÂæÖ„Å°„Å™„Åï„ÅÑ„Çà‚ÅâÔ∏è" },
                    { char: null, text: "ÔºàÈÅ†„Åñ„Åã„ÇãÂ£∞Ôºâ" },
                    { char: 'sonemi', text: "„ÅÜ„Åù„Åß„Åó„Çá‚Ä¶Ë°å„Å£„Å°„ÇÉ„Å£„Åü‚Ä¶„ÄÇ" },
                    { char: 'sonemi', text: "‚Ä¶‚Ä¶ÁßÅ„ÅÆ„Çπ„Éà„É¨„Çπ„ÄÅ„Å©„Åì„Å´„Å∂„Å§„Åë„Çå„Å∞„ÅÑ„ÅÑ„ÅÆ„Çà„Åä„Åä„Åä„Åä„Åä‚ÄºÔ∏è‚ÄºÔ∏è‚ÄºÔ∏èüëäüí•" },
                    { char: null, text: "„ÄêTHE END„Äë" }
                ]}
            ];

            let hp = 100;
            let score = 0;
            let combo = 0;
            let comboTimer = null;
            let currentIdx = 0;
            let novelStep = 0;
            let gameState = 'title';
            let activeEnemies = [];
            let enemiesLeft = 0;
            let spawnTimer = null;

            function gameStart() {
                document.getElementById('title-screen').style.display = 'none';
                loadScenario(0);
            }

            function loadScenario(idx) {
                currentIdx = idx;
                if (idx >= SCENARIOS.length) {
                    showResult();
                    return;
                }
                const s = SCENARIOS[idx];
                if (s.bg) document.getElementById('bg-layer').style.backgroundImage = `url('${s.bg}')`;

                if (s.type === 'novel') {
                    gameState = 'novel';
                    novelStep = 0;
                    document.getElementById('novel-scene').classList.remove('hidden');
                    document.getElementById('action-scene').classList.add('hidden');
                    renderNovel();
                } else {
                    startAction(s);
                }
            }

            function renderNovel() {
                const step = SCENARIOS[currentIdx].steps[novelStep];
                const charContainer = document.getElementById('novel-chars');
                charContainer.innerHTML = '';
                if (step.char) {
                    const data = CHARS[step.char];
                    document.getElementById('name-tag').innerText = data.name;
                    document.getElementById('name-tag').className = `w-fit self-start px-4 py-1 text-white rounded-t-lg font-bold ${data.color}`;
                    document.getElementById('name-tag').style.display = 'inline-block';
                    const el = document.createElement('div');
                    el.innerText = data.emoji; el.className = "text-9xl animate-bounce";
                    charContainer.appendChild(el);
                } else {
                    document.getElementById('name-tag').style.display = 'none';
                }
                document.getElementById('message-text').innerText = step.text;
            }

            function nextNovelStep() {
                if (gameState !== 'novel') return;
                novelStep++;
                if (novelStep < SCENARIOS[currentIdx].steps.length) renderNovel();
                else loadScenario(currentIdx + 1);
            }

            function startAction(config) {
                gameState = 'action';
                enemiesLeft = config.count;
                activeEnemies = [];
                document.getElementById('enemy-count').innerText = enemiesLeft;
                document.getElementById('novel-scene').classList.add('hidden');
                document.getElementById('action-scene').classList.remove('hidden');
                let spawned = 0;
                const spawnLoop = () => {
                    if (gameState !== 'action' || spawned >= config.count) return;
                    spawnEnemy(config.enemyEmoji, config.speedBase);
                    spawned++;
                    const nextInterval = config.speedBase * (0.2 + Math.random() * 0.4);
                    spawnTimer = setTimeout(spawnLoop, nextInterval);
                };
                spawnLoop();
                requestAnimationFrame(updateLoop);
            }

            function spawnEnemy(emoji, speed) {
                const el = document.createElement('div');
                el.innerText = emoji;
                el.className = "absolute text-7xl enemy-approach";
                const randomX = 50 + (Math.random() * 30 - 15);
                el.style.setProperty('--speed', speed + 'ms');
                el.style.left = randomX + "%";
                el.style.top = "40%";
                document.getElementById('enemy-container').appendChild(el);
                const enemy = { el, start: Date.now(), speed, hit: false };
                activeEnemies.push(enemy);

                setTimeout(() => {
                    if (!enemy.hit && gameState === 'action') {
                        takeDamage(10);
                        score = Math.max(0, score - 50);
                        updateScoreDisplay();
                        enemiesLeft--;
                        document.getElementById('enemy-count').innerText = enemiesLeft;
                        el.remove();
                        checkClear();
                    }
                    activeEnemies = activeEnemies.filter(e => e !== enemy);
                }, speed);
            }

            function updateLoop() {
                if (gameState !== 'action') return;
                const now = Date.now();
                let anyCritical = false;
                activeEnemies.forEach(e => {
                    const progress = (now - e.start) / e.speed;
                    if (progress > 0.65 && progress < 0.95 && !e.hit) anyCritical = true;
                });
                document.getElementById('target-guide').className = anyCritical ? 'active' : '';
                requestAnimationFrame(updateLoop);
            }

            function tryPunch(e) {
                if (e) e.preventDefault();
                if (gameState !== 'action') return;

                const fist = document.getElementById('player-fist');
                fist.classList.remove('punch-action'); void fist.offsetWidth; fist.classList.add('punch-action');

                const now = Date.now();
                let hitCount = 0;
                let resetCombo = true;
                activeEnemies.forEach(e => {
                    const progress = (now - e.start) / e.speed;
                    if (progress > 0.6 && progress < 0.98 && !e.hit) {
                        e.hit = true;
                        let rating = "";
                        let pointMult = 1;

                        if (progress >= 0.80 && progress <= 0.98) {
                            rating = "‚ú®PERFECT‚ú®";
                            pointMult = 2;
                            hp = Math.min(100, hp + 2);
                            resetCombo = false;
                        } else if (progress >= 0.65 && progress < 0.80) {
                            rating = "üëçGOOD";
                            pointMult = 1;
                            hp = Math.min(100, hp + 1);
                            resetCombo = false;
                        } else {
                            rating = "üí¶BAD";
                            pointMult = 0.5;
                        }

                        e.el.remove();
                        enemiesLeft--;
                        document.getElementById('enemy-count').innerText = enemiesLeft;
                        hitCount++;

                        let comboBonus = Math.floor(combo / 10) * 50;
                        score += Math.floor((100 + comboBonus) * pointMult);
                        showEffect(rating, e.el.style.left);
                    }
                });

                if (hitCount > 0) {
                    if (resetCombo) {
                        combo = 0;
                    } else {
                        combo += hitCount;
                    }
                    updateScoreDisplay();
                    showComboEffect();

                    if (comboTimer) clearTimeout(comboTimer);
                    comboTimer = setTimeout(() => { combo = 0; hideComboEffect(); }, 1500);

                    updateHpBar();
                    checkClear();
                } else {
                    combo = 0;
                    hideComboEffect();
                }
            }

            function showEffect(txt, leftPos) {
                const eff = document.createElement('div');
                eff.innerText = txt;

                let textColor = "text-white";
                if (txt.includes("PERFECT")) {
                    textColor = "text-yellow-400 text-6xl font-black";
                } else if (txt.includes("GOOD")) {
                    textColor = "text-blue-400 text-4xl font-bold";
                } else if (txt.includes("BAD")) {
                    textColor = "text-gray-500 text-3xl font-bold";
                } else {
                    textColor = "text-pink-500 text-8xl";
                }

                eff.className = `absolute z-50 pointer-events-none text-shadow animate-bounce ${textColor}`;
                eff.style.left = leftPos || "50%";
                eff.style.top = "35%";
                eff.style.transform = "translate(-50%, -50%)";

                document.getElementById('action-scene').appendChild(eff);

                setTimeout(() => {
                    eff.style.transition = "opacity 0.2s";
                    eff.style.opacity = "0";
                    setTimeout(() => eff.remove(), 200);
                }, 500);
            }
            function showComboEffect() {
                let comboEl = document.getElementById('combo-display');
                if (!comboEl) {
                    comboEl = document.createElement('div');
                    comboEl.id = 'combo-display';
                    comboEl.className = "absolute top-1/2 left-4 z-50 text-5xl font-black text-yellow-400 text-shadow italic animate-pulse";
                    document.getElementById('action-scene').appendChild(comboEl);
                }
                if (combo > 1) {
                    comboEl.innerText = combo + " COMBO!!";
                }
            }
            function hideComboEffect() {
                const comboEl = document.getElementById('combo-display');
                if (comboEl) comboEl.innerText = "";
            }

            function updateScoreDisplay() {
                const el = document.getElementById('score-val');
                if(el) el.innerText = score;
            }

            function showResult() {
                gameState = 'result';
                document.getElementById('action-scene').classList.add('hidden');
                document.getElementById('result-screen').classList.remove('hidden');
                document.getElementById('final-score').innerText = score;

                // „Çπ„Ç≥„Ç¢„Å´Âøú„Åò„Å¶„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂ§â„Åà„Çã„ÇàÔºÅ
                let msg = "";
                if (score >= 50000) {
                    msg = "üò§„Äå„ÅÇ„Çì„Åü„ÄÅ„Éó„É≠„ÅÆ„Çµ„É≥„Éâ„Éê„ÉÉ„Ç∞ËÅ∑‰∫∫„Å≠ÔºÅÊÉö„ÇåÊÉö„Çå„Åô„Çã„Çèüëä‚ú®„Äç";
                } else if (score >= 30000) {
                    msg = "„Äå„Åµ„Çì„ÄÅ„Åæ„ÅÇ„Åæ„ÅÇ„Å≠„ÄÇÂ∞ë„Åó„ÅØ„Çπ„ÉÉ„Ç≠„É™„Åó„Åü„Çèüò§„Äç";
                } else if (score >= 10000) {
                    msg = "üò§„Äå„Åæ„Å†„Åæ„Å†‰øÆË°å„ÅåË∂≥„Çä„Å™„ÅÑ„Çè„Å≠ÔºÅÂá∫Áõ¥„Åó„Å¶„Åç„Å™„Åï„ÅÑÔºÅüëä„Äç";
                } else {
                    msg = "üò§„Äå„Å°„Çá„Å£„Å®ÔºÅÂÖ®ÁÑ∂ÂΩì„Åü„Å£„Å¶„Å™„ÅÑ„Åò„ÇÉ„Å™„ÅÑÔºÅÁßÅ„ÅÆ„Çπ„Éà„É¨„ÇπÂÄçÂ¢ó„ÇàÔºÅüí¢„Äç";
                }

                // „É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫„Åô„Çã„Åü„ÇÅ„ÅÆË¶ÅÁ¥†„Çí‰Ωú„Çã„Åã„ÄÅÊó¢Â≠ò„ÅÆÂ†¥ÊâÄ„Å´ÂÖ•„Çå„Çã„Çà
                let msgEl = document.getElementById('result-msg');
                if (!msgEl) {
                    msgEl = document.createElement('p');
                    msgEl.id = 'result-msg';
                    msgEl.className = "text-xl text-pink-500 font-bold mt-4 mb-6 px-4";
                    const scoreEl = document.getElementById('final-score');
                    scoreEl.parentNode.insertBefore(msgEl, scoreEl.nextSibling);
                }
                msgEl.innerText = msg;
            }

            function checkClear() {
                if (gameState !== 'action') return;
                if (enemiesLeft <= 0) {
                    gameState = 'transition';
                    if (spawnTimer) clearTimeout(spawnTimer);

                    setTimeout(() => {
                        loadScenario(currentIdx + 1);
                    }, 1000);
                }
            }

            function takeDamage(amt) {
                hp -= amt;
                combo = 0;
                hideComboEffect();
                updateHpBar();
                document.getElementById('game-container').classList.add('shake');
                setTimeout(() => document.getElementById('game-container').classList.remove('shake'), 300);
                if (hp <= 0) {
                    gameState = 'over';
                    document.getElementById('game-over').classList.remove('hidden');
                }
            }

            function updateHpBar() {
                const bar = document.getElementById('hp-bar');
                bar.style.width = Math.max(0, hp) + "%";
            }


        </script>
    </body>
</html>